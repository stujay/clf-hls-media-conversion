// README.hls-media-workflow.md
# CLF HLS Workflow — Architecture, Security, and Troubleshooting (Sept 2025)

## 1. High-Level Overview
- **Origins**: Amazon S3 (private bucket) → CloudFront (private distribution) → SvelteKit (Vercel) + hls.js player.
- **Access Control**: Signed URLs or Cookies generated by `/api/media-url` using `CF_PRIVATE_KEY_B64` (RSA key), `CF_KEY_PAIR_ID`, and path patterns (e.g., `/videos/<slug>/master.m3u8`).
- **Transcoding**: H.264/AAC in HLS (multi-bitrate renditions). Optional Dolby/Spatial audio support planned.
- **Storage Layout** (recommended):
  ```
  s3://clf-media/videos/<course>/<lesson>/
    master.m3u8
    v0/segment0001.ts
    v1/segment0001.ts
    ...
  ```
- **Player**: hls.js for MSE playback on desktop; native `<video>` element for Safari/iOS.

## 2. S3 Configuration

### 2.1 Bucket Policy
- Keep the bucket private. Grant access only via CloudFront Origin Access Control (OAC).

### 2.2 CORS Configuration
Configure a minimal and strict CORS policy allowing CloudFront/origin requests from your site domains:
```json
[
  {
    "AllowedOrigins": [
      "https://www.crackinglanguage.com",
      "https://crackinglanguage.com",
      "https://media.crackinglanguage.com"
    ],
    "AllowedMethods": ["GET", "HEAD"],
    "AllowedHeaders": ["Origin", "Range", "Access-Control-Request-Headers", "Access-Control-Request-Method"],
    "ExposeHeaders": ["Content-Length", "Content-Range"],
    "MaxAgeSeconds": 86400
  }
]
```
**Notes**:
- HLS uses Range requests; include `Range` and expose `Content-Range`.
- If signing cookies under `media.crackinglanguage.com`, include it in `AllowedOrigins`.

## 3. CloudFront Configuration

### 3.1 Origins & OAC
- **Origin**: The S3 bucket with Origin Access Control (OAC).

### 3.2 Behaviors
- **Path Pattern**: `/videos/*` (or your preferred prefix), with a cache policy that whitelists headers used for CORS (e.g., `Origin`) and allows query strings for signed URLs.
- **Minimum TTLs**: Use default or small values (e.g., 60s) during debugging; increase later.

### 3.3 Response Headers Policy
Add or attach a response headers policy that includes:
- `Access-Control-Allow-Origin`: `https://www.crackinglanguage.com` (or `https://*.crackinglanguage.com` for subdomains).
- `Access-Control-Allow-Methods`: `GET, HEAD`
- `Access-Control-Allow-Headers`: `Origin, Range`
- `Access-Control-Expose-Headers`: `Content-Length, Content-Range`
- `Referrer-Policy`: `no-referrer-when-downgrade`
- `X-Content-Type-Options`: `nosniff`

### 3.4 MIME Types
Ensure CloudFront/S3 serve correct MIME types:
- `.m3u8` → `application/vnd.apple.mpegurl`
- `.ts` → `video/mp2t`
- `.mp4` → `video/mp4`

## 4. DNS and Cookies Strategy
- Use a stable CNAME for the distribution, e.g., `media.crackinglanguage.com`, instead of the rotating CloudFront domain.
- For signed cookies, set the cookie `Domain` to `.crackinglanguage.com` and serve HLS from `media.crackinglanguage.com` to ensure the browser sends cookies with segment requests.
- For signed URLs, ensure the player uses the signed URL for the manifest and segment base path.

## 5. SvelteKit (Vercel) Headers/CSP
**Issue**: Console error:
```
Refused to connect to 'https://d2hndeao0wd5o.cloudfront.net/.../master.m3u8' because it violates Content Security Policy: connect-src ...
```

### 5.1 Add CDN Domain to CSP
If using the raw CloudFront domain, allow it explicitly. Preferably, use a CNAME like `media.crackinglanguage.com`. Example for Vercel `vercel.json`:
```json
{
  "headers": [
    {
      "source": "/(.*)",
      "headers": [
        {
          "key": "Content-Security-Policy",
          "value": "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://*.crackinglanguage.com https://*.cloudfront.net; media-src 'self' https://media.crackinglanguage.com https://*.cloudfront.net; connect-src 'self' https://clf-autogen-server-production.up.railway.app https://xjkckgntibtppdiwwzxs.supabase.co https://api.openai.com https://www.google-analytics.com https://analytics.google.com https://stats.g.doubleclick.net https://www.facebook.com https://web.facebook.com https://connect.facebook.net https://media.crackinglanguage.com https://*.cloudfront.net; frame-src 'self';"
        }
      ]
    }
  ]
}
```
**Recommendation**: Switch player URLs to `https://media.crackinglanguage.com/...` to remove the need for `https://*.cloudfront.net` in CSP.

### 5.2 Alternative CSP (SvelteKit Runtime)
Set per-response headers in SvelteKit:
```typescript
// src/hooks.server.ts
// Ensure adapter-vercel doesn’t override; Vercel’s headers are simpler for global CSP.
import type { Handle } from '@sveltejs/kit';

export const handle: Handle = async ({ event, resolve }) => {
  const response = await resolve(event, {
    filterSerializedResponseHeaders: (name) => name === 'content-type'
  });
  response.headers.set(
    'Content-Security-Policy',
    "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https://media.crackinglanguage.com; media-src 'self' https://media.crackinglanguage.com; connect-src 'self' https://media.crackinglanguage.com https://clf-autogen-server-production.up.railway.app https://xjkckgntibtppdiwwzxs.supabase.co https://api.openai.com; frame-src 'self';"
  );
  return response;
};
```

## 6. Signed Access Generation

### 6.1 API Contract
- **Endpoint**: `GET /api/media-url?key=<media-key>` → Returns a signed absolute URL to the HLS master manifest or sets signed cookies and returns the manifest URL.
- **Key Lookup**: Map the key to S3 path (e.g., `ctf-s1-e1-intro` → `/videos/ctf-s1-e1-intro/master.m3u8`).
- **Expiry**: 5–30 minutes typical.

### 6.2 Implementation Notes
- Load the RSA private key from `CF_PRIVATE_KEY_B64` (PKCS#8). Base64 must decode into a valid PEM; ensure no extra quotes after decoding and that newlines are restored.
- For Vercel environments, if the base64 contains `+` or `/`, quoting is not required, but copying via shell can mangle it; store via Vercel UI or `vercel env` CLI.
- If using cookies, ensure the `Domain` and CNAME align (see §4). hls.js will need `xhrSetup` to send cookies only if cross-site.

## 7. Player Implementation (SvelteKit)
```svelte
<!-- src/lib/components/HlsPlayer.svelte -->
<script lang="ts">
  import Hls from 'hls.js';
  import { onMount, onDestroy } from 'svelte';
  export let mediaKey: string;            // e.g., 'ctf-s1-e1-intro'
  export let poster: string | undefined;  // optional
  let videoEl: HTMLVideoElement;
  let hls: Hls | null = null;

  async function getManifestUrl(key: string) {
    const res = await fetch(`/api/media-url?key=${encodeURIComponent(key)}`);
    if (!res.ok) throw new Error('Failed to get media URL');
    const data = await res.json();
    return data.url as string; // absolute URL to master.m3u8
  }

  onMount(async () => {
    const src = await getManifestUrl(mediaKey);
    if (Hls.isSupported()) {
      hls = new Hls({ enableWorker: true });
      // If using signed cookies cross-site, uncomment:
      // hls.config.xhrSetup = (xhr) => { xhr.withCredentials = true; };
      hls.loadSource(src);
      hls.attachMedia(videoEl);
    } else if (videoEl.canPlayType('application/vnd.apple.mpegurl')) {
      videoEl.src = src; // Safari/iOS
    } else {
      console.warn('HLS not supported');
    }
  });

  onDestroy(() => {
    hls?.destroy();
  });
</script>

<video bind:this={videoEl}
       controls
       playsinline
       preload="metadata"
       crossorigin="anonymous"
       {poster}
       style="width: 100%; height: auto; border-radius: 12px;">
</video>
```

## 8. Encoding Pipeline (Baseline)
- **Input**: Master MP4 (ProRes or mezzanine).
- **Transcode to Ladder** (example):
  - 1080p @ 5800 kbps
  - 720p @ 3200 kbps
  - 480p @ 1600 kbps
  - 360p @ 800 kbps
- **Audio**: AAC-LC 128 kbps stereo.
- **Segment**: 6s duration, `#EXT-X-VERSION: 3` or later.
- **Tools**: AWS MediaConvert (templated), ffmpeg pipeline, or third-party service.

## 9. Troubleshooting Guide

### 9.1 CSP "Refused to connect … master.m3u8"
- **Symptom**: Manifest/segments blocked.
- **Fix**:
  1. Add your CDN host to `connect-src` and `media-src` (see §5.1).
  2. Prefer CNAME `media.crackinglanguage.com` and use it consistently.

### 9.2 CORS Errors or Stalled Playback
- Ensure S3 CORS includes `Range` and exposes `Content-Range` (§2.2).
- Verify CloudFront response headers (§3.3).
- Check MIME types (§3.4).

### 9.3 403 on Segments with Signed Cookies
- **Issue**: Cookie `Domain` doesn’t match CDN host.
- **Fix**: Serve via `media.crackinglanguage.com` and set cookie `Domain` to `.crackinglanguage.com`.
- If cross-site, set `xhr.withCredentials = true` in hls.js.

### 9.4 "Non-passive Event Listener … touchstart/touchmove"
- **Issue**: Performance warning, not a blocker.
- **Fix**: Where you control listeners, use:
  ```javascript
  element.addEventListener('touchstart', handler, { passive: true });
  ```
- Safe to ignore unless performance issues are observed.

### 9.5 Base64 Private Key Issues
- After decoding, the key must be a valid PEM: `-----BEGIN PRIVATE KEY----- … -----END PRIVATE KEY-----`.
- Avoid accidental quoting or line-break loss. Store via Vercel env UI.

### 9.6 Mixed Content / Bad Poster
- Ensure poster and all assets are HTTPS and allowed by CSP `img-src`.

## 10. Operational Checklist
- S3 bucket private, OAC enabled.
- CloudFront behavior `/videos/*` → S3 origin.
- Response headers policy with CORS + security headers.
- DNS CNAME `media.crackinglanguage.com` → CloudFront distribution.
- CSP updated to allow `media.crackinglanguage.com` (and temporarily `*.cloudfront.net`).
- `/api/media-url` returns absolute signed manifest URL; expiry sensible.
- hls.js configured; cookies vs. URLs choice documented.
- MIME types correct.
- Range/Expose headers verified.

## 11. Future Hardening
- **Token Binding**: Include user/session claims in the path policy when feasible.
- **Hotlink Protection**: Signed URLs + short TTL + IP or UA constraints.
- **Download Resistance**: HLS + DRM (FairPlay/Widevine via CMAF) if needed.
- **Observability**: CloudFront logs to S3 + Athena/Lake Formation for analytics.

---

## Next Actions for Current Error
1. Add `media.crackinglanguage.com` (or your actual CDN host) to `connect-src` and `media-src` in CSP.
2. If using the raw CloudFront hostname, temporarily allow `https://*.cloudfront.net` in CSP while migrating to a CNAME.
3. Confirm S3/CloudFront CORS headers include `Range` and expose `Content-Range`.
4. Re-test the lesson: `/api/media-url?key=ctf-s1-e1-intro` should yield a URL that loads `master.m3u8` without CSP or CORS errors.
